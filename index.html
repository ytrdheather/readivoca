<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Readitude Voca</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 700px; text-align: center; margin-top: 50px; margin-bottom: 50px; }
        h2 { color: #333; margin-bottom: 1rem; }
        
        /* ë¸Œëœë“œ ì»¬ëŸ¬: #32bfb6 */
        .btn-primary { background-color: #32bfb6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; width: 100%; margin-top: 10px; }
        .btn-primary:hover { background-color: #289f97; }
        .btn-secondary { background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 15px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* --- í•™ìŠµ ë©”ë‰´ (4ë‹¨ê³„ ë²„íŠ¼) --- */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .menu-card { 
            background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .menu-card:hover { border-color: #32bfb6; background: #e6f7f6; transform: translateY(-3px); }
        .menu-card i { font-size: 2rem; color: #32bfb6; margin-bottom: 10px; }
        .menu-card h3 { margin: 0; font-size: 1.1rem; color: #333; }
        .menu-card p { margin: 5px 0 0; font-size: 0.8rem; color: #666; }

        /* --- ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ --- */
        .teacher-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .teacher-table th, .teacher-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .teacher-table th { background-color: #32bfb6; color: white; }
        .print-area { display: none; }

        /* --- í€´ì¦ˆ/ìŠ¤í ë§ ìŠ¤íƒ€ì¼ --- */
        .question-box { font-size: 1.5rem; font-weight: bold; margin: 20px 0; color: #333; min-height: 60px; display: flex; align-items: center; justify-content: center; word-break: keep-all; line-height: 1.4; padding: 0 10px; }
        .hint-text { color: #888; font-size: 0.9rem; margin-bottom: 10px; font-style: italic; }
        .score-board { font-size: 1.2rem; font-weight: bold; color: #32bfb6; margin-bottom: 10px; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn { background: white; border: 1px solid #ccc; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .option-btn:hover { background: #f0f0f0; }
        .option-btn.correct { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .option-btn.wrong { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        /* --- ìŠ¤í ë§ ê²°ê³¼ í™”ë©´ ìŠ¤íƒ€ì¼ --- */
        .wrong-list-container { text-align: left; background: #fff0f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffcccc; max-height: 300px; overflow-y: auto; }
        .wrong-item { border-bottom: 1px solid #ffdddd; padding: 8px 0; display: flex; justify-content: space-between; }
        .wrong-item:last-child { border-bottom: none; }
        .wrong-en { font-weight: bold; color: #d63384; }
        .wrong-ko { color: #555; }

        /* --- ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ --- */
        @media print {
            body { background: white; display: block; }
            .container, .no-print { display: none !important; }
            .print-area { display: block !important; padding: 20px; }
            .print-header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 20px; padding-bottom: 10px; }
            .print-table { width: 100%; border-collapse: collapse; }
            .print-table td { border-bottom: 1px solid #ccc; padding: 15px 5px; font-size: 12pt; }
            .print-col-left { width: 40%; font-weight: bold; }
            .print-col-right { width: 60%; }
        }
        
        /* í”Œë˜ì‹œì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card-container { perspective: 1000px; width: 100%; height: 600px; margin-bottom: 15px; cursor: pointer; }
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 15px; padding: 30px; box-sizing: border-box; background: white; border: 2px solid #e0e0e0; overflow-y: hidden; }
        .front { font-size: 3rem; font-weight: bold; color: #333; }
        .back { transform: rotateY(180deg); background-color: #f8f9fa; color: #555; justify-content: start; padding-top: 60px; }
        
        .meaning-text { font-size: 2rem; font-weight: bold; color: #222; margin-bottom: 20px; word-break: keep-all; }
        .info-box { width: 100%; background: white; border-radius: 8px; padding: 15px; margin-top: 10px; text-align: left; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: none; line-height: 1.6; }
        .info-label { font-size: 0.85rem; font-weight: bold; color: #32bfb6; display: block; margin-bottom: 5px; text-transform: uppercase; }

        .audio-btn {
            position: absolute; top: 20px; right: 20px;
            background: #e6f7f6; border-radius: 50%; width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center;
            color: #32bfb6; border: none; font-size: 1.3rem; cursor: pointer; z-index: 10;
        }
        .audio-btn:hover { background: #d1efed; transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="container">
        
        <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="login-section">
            <h2 style="color:#32bfb6"><i class="fa-solid fa-graduation-cap"></i> Readitude</h2>
            <p>ì˜¤ëŠ˜ì˜ í•™ìŠµì„ ì‹œì‘í•´ë³¼ê¹Œìš”?</p>
            <input type="text" id="username" placeholder="ì•„ì´ë”” (í•™ìƒ: student1 / ìŒ¤: admin)">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (1234)">
            <button class="btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
            <p id="message" style="color:red; font-size: 0.9rem; margin-top: 10px;"></p>
        </div>

        <!-- 2. êµì¬/ìœ ë‹› ì„ íƒ -->
        <div id="selection-section" class="hidden">
            <div style="text-align: right;">
                <button onclick="logout()" style="background:none; border:none; color:#999; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <h2 id="welcome-msg" style="color:#32bfb6">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <select id="book-select" onchange="loadUnits()">
                <option value="">ğŸ“š êµì¬ ì„ íƒ</option>
            </select>
            <select id="unit-select" disabled>
                <option value="">ğŸ“‚ ìœ ë‹› ì„ íƒ</option>
            </select>
            <button class="btn-primary" onclick="goToDashboard()">í•™ìŠµ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ ğŸš€</button>
        </div>

        <!-- 3. í•™ìŠµ ëŒ€ì‹œë³´ë“œ (4ë‹¨ê³„ ë©”ë‰´) -->
        <div id="dashboard-section" class="hidden">
            <h3 id="dash-unit-title" style="color:#555">Unit Name</h3>
            <p style="font-size:0.9rem; color:#888;">4ë‹¨ê³„ë¥¼ ëª¨ë‘ ì™„ë£Œí•˜ì—¬ ê¸ˆë©”ë‹¬ì„ íšë“í•˜ì„¸ìš”!</p>
            
            <div class="menu-grid">
                <div class="menu-card" onclick="startFlashcard()">
                    <i class="fa-solid fa-layer-group"></i>
                    <h3>1. ë‹¨ì–´ ì•”ê¸°</h3>
                    <p>í”Œë˜ì‹œì¹´ë“œë¡œ ì™¸ìš°ê¸°</p>
                </div>
                <div class="menu-card" onclick="startSpelling()">
                    <i class="fa-solid fa-keyboard"></i>
                    <h3>2. ìŠ¤í ë§ í•™ìŠµ</h3>
                    <p>íŒíŠ¸ ë³´ê³  íƒ€ì ì¹˜ê¸°</p>
                </div>
                <div class="menu-card" onclick="startContextQuiz()">
                    <i class="fa-solid fa-rotate"></i>
                    <h3>3. ë°˜ë³µ í›ˆë ¨</h3>
                    <p>ìœ ì˜ì–´/ì˜ˆë¬¸ í€´ì¦ˆ</p>
                </div>
                <div class="menu-card" onclick="startTest()">
                    <i class="fa-solid fa-file-signature"></i>
                    <h3>4. ì‹¤ì „ í…ŒìŠ¤íŠ¸</h3>
                    <p>ìµœì¢… ì ê²€</p>
                </div>
            </div>
            <button class="btn-secondary" onclick="goBackToSelection()">êµì¬ ë‹¤ì‹œ ê³ ë¥´ê¸°</button>
        </div>

        <!-- 4. í”Œë˜ì‹œì¹´ë“œ í™”ë©´ -->
        <div id="flashcard-section" class="hidden">
            <h3>ë‹¨ì–´ ì•”ê¸° (Flashcard)</h3>
            <div class="card-container" onclick="flipCard()">
                <div class="card" id="flashcard">
                    <div class="card-face front"><span id="fc-en">Apple</span></div>
                    <div class="card-face back">
                        <button class="audio-btn" onclick="event.stopPropagation(); playAudio()">
                            <i class="fa-solid fa-volume-high"></i>
                        </button>
                        <div class="meaning-text" id="fc-ko">ì‚¬ê³¼</div>
                        <div class="info-box" id="fc-ex"><span class="info-label">EXAMPLE</span><span id="fc-ex-text"></span></div>
                        <div class="info-box" id="fc-syn"><span class="info-label">SYNONYMS</span><span id="fc-syn-text"></span></div>
                        <div class="info-box" id="fc-ant"><span class="info-label">ANTONYMS</span><span id="fc-ant-text"></span></div>
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="btn-primary" style="width:120px" onclick="prevCard()">ì´ì „</button>
                <button class="btn-primary" style="width:120px" onclick="nextCard()">ë‹¤ìŒ (Enter)</button>
            </div>
            <p style="font-size: 0.8rem; color: #999; margin-top: 10px;">Tip: Spaceë¡œ ë’¤ì§‘ê³ , Enterë¡œ ë„˜ê¸°ì„¸ìš”!</p>
            <button class="btn-secondary" onclick="backToDashboard()">ëŒ€ì‹œë³´ë“œë¡œ</button>
        </div>

        <!-- 5. ìŠ¤í ë§ í•™ìŠµ í™”ë©´ -->
        <div id="spelling-section" class="hidden">
            <h3>ìŠ¤í ë§ í•™ìŠµ (Typing)</h3>
            <div class="score-board">ì ìˆ˜: <span id="spell-score">0</span> / 100</div>
            <div class="question-box" id="spell-meaning">ì‚¬ê³¼</div>
            <div class="hint-text" id="spell-hint">Hint: A _ _ _ e</div>
            
            <input type="text" id="spell-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" style="font-size:1.2rem; text-align:center;" autocomplete="off">
            <button class="btn-primary" onclick="checkSpelling()">í™•ì¸ (Enter)</button>
            <p id="spell-feedback" style="height:20px; font-weight:bold;"></p>
            <button class="btn-secondary" onclick="backToDashboard()">ê·¸ë§Œí•˜ê¸°</button>
        </div>

        <!-- 5-1. ìŠ¤í ë§ í•™ìŠµ ê²°ê³¼ (NEW) -->
        <div id="spelling-result-section" class="hidden">
            <h3>ìŠ¤í ë§ í•™ìŠµ ì™„ë£Œ! ğŸ‰</h3>
            <p id="spelling-result-msg" style="margin-bottom:15px; color:#555;">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
            
            <!-- ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì˜ì—­ -->
            <div id="wrong-word-list-area" class="hidden">
                <h4 style="color:#dc3545; margin-bottom:10px;">âŒ í‹€ë¦° ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸</h4>
                <div id="wrong-word-list" class="wrong-list-container">
                    <!-- JSë¡œ ì±„ì›Œì§ -->
                </div>
                <button class="btn-primary" style="background-color:#ff6b6b;" onclick="startRetryWrong()">ğŸ”¥ í‹€ë¦° ë‹¨ì–´ë§Œ 2ì°¨ ë³µìŠµí•˜ê¸°</button>
            </div>

            <!-- ë‹¤ ë§ì•˜ì„ ë•Œ í‘œì‹œ -->
            <div id="perfect-score-area" class="hidden">
                <i class="fa-solid fa-crown" style="font-size:3rem; color:#ffc107; margin:20px 0;"></i>
                <h3 style="color:#28a745;">Perfect! ëª¨ë“  ë‹¨ì–´ë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!</h3>
            </div>

            <button class="btn-secondary" onclick="backToDashboard()">ëŒ€ì‹œë³´ë“œë¡œ</button>
        </div>

        <!-- 6. ë°˜ë³µ í›ˆë ¨ í™”ë©´ -->
        <div id="quiz-section" class="hidden">
            <h3>ë°˜ë³µ í›ˆë ¨ (Context Quiz)</h3>
            <div class="score-board" id="quiz-progress">1 / 50</div>
            <div class="question-box" id="quiz-question" style="font-size:1.1rem; font-weight:normal;"></div>
            <div class="hint-text" id="quiz-type-badge"></div>
            <div class="option-grid" id="quiz-options"></div>
            <button class="btn-secondary" onclick="backToDashboard()">ê·¸ë§Œí•˜ê¸°</button>
        </div>

        <!-- 7. ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ -->
        <div id="teacher-section" class="hidden">
            <h2 style="color:#32bfb6">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬ ëª¨ë“œ</h2>
            <p>í•™ìƒë“¤ì˜ í•™ìŠµ í˜„í™©ì„ í™•ì¸í•˜ê³  ì¶œë ¥í•˜ì„¸ìš”.</p>
            <select id="teacher-book-select" onchange="renderTeacherTable()">
                <option value="">êµì¬ ì„ íƒ</option>
            </select>
            <table class="teacher-table">
                <thead>
                    <tr>
                        <th>í•™ìƒëª…</th>
                        <th>ìœ ë‹›</th>
                        <th>ì§„í–‰ë¥ </th>
                        <th>ì ìˆ˜</th>
                        <th>ì™„ë£Œì¼</th>
                    </tr>
                </thead>
                <tbody id="teacher-tbody"></tbody>
            </table>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-primary" onclick="printTestPaper('test')">ğŸ“„ ì‹œí—˜ì§€ ì¶œë ¥</button>
                <button class="btn-primary" style="background-color:#ffc107; color:#333;" onclick="printTestPaper('workbook')">ğŸ“˜ ì›Œí¬ë¶ ì¶œë ¥</button>
            </div>
            <button class="btn-secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- ì¸ì‡„ìš© ì˜ì—­ -->
    <div id="print-area" class="print-area">
        <div class="print-header">
            <h1 id="print-title">Vocabulary Test</h1>
            <p>Name: __________________ &nbsp;&nbsp; Date: __________________ &nbsp;&nbsp; Score: ______</p>
        </div>
        <table class="print-table">
            <tbody id="print-tbody"></tbody>
        </table>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';

        let currentWords = [];
        let currentIndex = 0;
        let userType = 'student';
        
        let quizQueue = [];

        // ìŠ¤í ë§ í•™ìŠµìš© ë³€ìˆ˜
        let wrongAnswers = [];        // í‹€ë¦° ë‹¨ì–´ë“¤ ì €ì¥ì†Œ
        let isCurrentWordWrong = false; // í˜„ì¬ ë‹¨ì–´ë¥¼ í‹€ë ¸ëŠ”ì§€ ì—¬ë¶€ (íŒíŠ¸ ìš©)

        // --- 1. ë¡œê·¸ì¸ ---
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === '1234') {
                userType = 'teacher';
                showSection('teacher-section');
                initTeacherView();
                return;
            }

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (res.ok) {
                    userType = 'student';
                    showSection('selection-section');
                    document.getElementById('welcome-msg').innerText = `${data.student_name}ë‹˜, ì˜¤ëŠ˜ë„ í™”ì´íŒ…!`;
                    loadBooks(); 
                } else {
                    document.getElementById('message').innerText = 'âŒ ' + data.message;
                }
            } catch (err) {
                alert("ì„œë²„ê°€ ì¼œì ¸ìˆì§€ ì•Šì€ ê²ƒ ê°™ì•„ìš”. (localhost:3000)");
                console.error(err);
            }
        }

        function logout() { location.reload(); }

        // --- 2. êµì¬/ìœ ë‹› ë¡œë“œ ---
        async function loadBooks() {
            try {
                const res = await fetch(`${API_URL}/books`);
                const books = await res.json();
                const select = document.getElementById('book-select');
                
                select.innerHTML = '<option value="">ğŸ“š êµì¬ ì„ íƒ</option>';
                books.forEach(book => {
                    const opt = document.createElement('option');
                    opt.value = book; opt.innerText = book; select.appendChild(opt);
                });

                const tSelect = document.getElementById('teacher-book-select');
                if(tSelect) {
                    tSelect.innerHTML = '<option value="">êµì¬ ì„ íƒ</option>';
                    books.forEach(book => {
                        const opt = document.createElement('option');
                        opt.value = book; opt.innerText = book; tSelect.appendChild(opt);
                    });
                }
            } catch(err) { console.error(err); }
        }

        async function loadUnits() {
            const bookName = document.getElementById('book-select').value;
            const unitSelect = document.getElementById('unit-select');
            unitSelect.innerHTML = '<option>ğŸ“‚ ìœ ë‹› ì„ íƒ</option>';
            unitSelect.disabled = true;
            if(!bookName) return;

            try {
                const res = await fetch(`${API_URL}/units?book_name=${encodeURIComponent(bookName)}`);
                const units = await res.json();
                units.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u; opt.innerText = u; unitSelect.appendChild(opt);
                });
                unitSelect.disabled = false;
            } catch(err) { console.error(err); }
        }

        async function goToDashboard() {
            const bookName = document.getElementById('book-select').value;
            const unitName = document.getElementById('unit-select').value;
            if(!bookName || !unitName) return alert('êµì¬ì™€ ìœ ë‹›ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”!');
            
            try {
                const res = await fetch(`${API_URL}/start-learning`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ book_name: bookName, unit_name: unitName })
                });
                const words = await res.json();

                if (words.length === 0) return alert("ì´ ìœ ë‹›ì—ëŠ” ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");

                currentWords = words;
                document.getElementById('dash-unit-title').innerText = `${bookName} - ${unitName}`;
                showSection('dashboard-section');

            } catch(err) {
                alert("ë‹¨ì–´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // --- 3. ê¸°ëŠ¥ë³„ ë¡œì§ ---

        // [ê¸°ëŠ¥ 1] í”Œë˜ì‹œì¹´ë“œ
        function startFlashcard() {
            showSection('flashcard-section');
            currentIndex = 0;
            loadFlashcard(0);
        }

        function loadFlashcard(idx) {
            const w = currentWords[idx];
            document.getElementById('fc-en').innerText = w.english;
            document.getElementById('fc-ko').innerText = w.meaning;
            
            const exBox = document.getElementById('fc-ex');
            if(w.example) { exBox.style.display='block'; document.getElementById('fc-ex-text').innerText=w.example; } 
            else exBox.style.display='none';

            const synBox = document.getElementById('fc-syn');
            if(w.synonyms) { synBox.style.display='block'; document.getElementById('fc-syn-text').innerText=w.synonyms; }
            else synBox.style.display='none';

            const antBox = document.getElementById('fc-ant');
            if(w.antonyms) { antBox.style.display='block'; document.getElementById('fc-ant-text').innerText=w.antonyms; }
            else antBox.style.display='none';

            document.getElementById('flashcard').classList.remove('flipped');
            isFlipped = false;
        }

        function flipCard() { 
            document.getElementById('flashcard').classList.toggle('flipped'); 
            isFlipped = !isFlipped;
            if (isFlipped) playAudio();
        }

        function playAudio() {
            const text = currentWords[currentIndex].english;
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            }
        }

        function nextCard() { if(currentIndex < currentWords.length-1) loadFlashcard(++currentIndex); else alert("ë§ˆì§€ë§‰ ë‹¨ì–´ì…ë‹ˆë‹¤!"); }
        function prevCard() { if(currentIndex > 0) loadFlashcard(--currentIndex); }

        // [ê¸°ëŠ¥ 2] ìŠ¤í ë§ í•™ìŠµ (ì˜¤ë‹µë…¸íŠ¸ ê¸°ëŠ¥ ì¶”ê°€ë¨)
        let spellWord = null;
        let isReviewMode = false; // ë³µìŠµ ëª¨ë“œì¸ì§€ ì—¬ë¶€

        function startSpelling() {
            showSection('spelling-section');
            currentIndex = 0;
            wrongAnswers = []; // ì˜¤ë‹µ ì´ˆê¸°í™”
            isReviewMode = false;
            loadSpellingQuestion();
        }

        function loadSpellingQuestion() {
            const w = currentWords[currentIndex];
            spellWord = w.english;
            isCurrentWordWrong = false; // ìƒˆ ë¬¸ì œ ì‹œì‘í•  ë•Œ ì˜¤ë‹µ ì—¬ë¶€ ì´ˆê¸°í™”

            document.getElementById('spell-meaning').innerText = w.meaning;
            document.getElementById('spell-input').value = '';
            document.getElementById('spell-feedback').innerText = '';
            
            // íŒíŠ¸ ìƒì„±
            let hint = w.english[0] + ' ' + Array(w.english.length).join('_ ');
            document.getElementById('spell-hint').innerText = `Hint: ${hint}`;
            
            // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            document.getElementById('spell-score').innerText = `${currentIndex + 1}/${currentWords.length}`;
            
            document.getElementById('spell-input').focus();
        }

        function checkSpelling() {
            const input = document.getElementById('spell-input').value.trim();
            const feedback = document.getElementById('spell-feedback');
            
            if(input.toLowerCase() === spellWord.toLowerCase()) {
                // ì •ë‹µ!
                feedback.style.color = 'green';
                feedback.innerText = "ë”©ë™ëŒ•! ì •ë‹µì…ë‹ˆë‹¤ ğŸ‰";
                
                // ë§Œì•½ í•œ ë²ˆì´ë¼ë„ í‹€ë ¸ë˜ ë‹¨ì–´ë¼ë©´ ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
                if (isCurrentWordWrong) {
                    const alreadyExists = wrongAnswers.some(w => w.id === currentWords[currentIndex].id);
                    if (!alreadyExists) {
                        wrongAnswers.push(currentWords[currentIndex]);
                    }
                }

                setTimeout(() => {
                    if(currentIndex < currentWords.length-1) {
                        currentIndex++;
                        loadSpellingQuestion();
                    } else {
                        // í•™ìŠµ ì¢…ë£Œ -> ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
                        showSpellingResult();
                    }
                }, 800);
            } else {
                // ì˜¤ë‹µ!
                feedback.style.color = 'red';
                feedback.innerText = "ë•¡! ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.";
                isCurrentWordWrong = true; // í‹€ë ¸ìŒì„ ì²´í¬
            }
        }

        // ê²°ê³¼ í™”ë©´ í‘œì‹œ í•¨ìˆ˜
        function showSpellingResult() {
            showSection('spelling-result-section');
            const listArea = document.getElementById('wrong-word-list-area');
            const perfectArea = document.getElementById('perfect-score-area');
            const listDiv = document.getElementById('wrong-word-list');

            if (wrongAnswers.length === 0) {
                // ë‹¤ ë§ìŒ
                listArea.classList.add('hidden');
                perfectArea.classList.remove('hidden');
            } else {
                // í‹€ë¦° ê²Œ ìˆìŒ
                perfectArea.classList.add('hidden');
                listArea.classList.remove('hidden');
                
                // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                listDiv.innerHTML = '';
                wrongAnswers.forEach(w => {
                    const item = document.createElement('div');
                    item.className = 'wrong-item';
                    item.innerHTML = `<span class="wrong-en">${w.english}</span><span class="wrong-ko">${w.meaning}</span>`;
                    listDiv.appendChild(item);
                });
            }
        }

        // 2ì°¨ ë³µìŠµ ì‹œì‘ í•¨ìˆ˜
        function startRetryWrong() {
            if (wrongAnswers.length === 0) return;
            
            // í˜„ì¬ í•™ìŠµ ë‹¨ì–´ë¥¼ 'í‹€ë¦° ë‹¨ì–´ë“¤'ë¡œ êµì²´
            currentWords = [...wrongAnswers];
            wrongAnswers = []; // ì˜¤ë‹µí†µ ë‹¤ì‹œ ë¹„ìš°ê¸° (2ì°¨ ë³µìŠµì—ì„œ ë˜ í‹€ë¦¬ë©´ ì—¬ê¸° ë‹¤ì‹œ ìŒ“ì„)
            currentIndex = 0;
            isReviewMode = true;
            
            alert("í‹€ë¦° ë‹¨ì–´ë§Œ ëª¨ì•„ì„œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤! ì§‘ì¤‘í•˜ì„¸ìš” ğŸ”¥");
            showSection('spelling-section');
            loadSpellingQuestion();
        }

        // [ê¸°ëŠ¥ 3] ë°˜ë³µ í›ˆë ¨ (í€´ì¦ˆ)
        function startContextQuiz() {
            showSection('quiz-section');
            
            quizQueue = [];
            // 50ë¬¸ì œ ìƒì„± ë¡œì§ (ì˜ë¯¸ 20, ì˜ˆë¬¸ 20, ìœ ì˜ì–´/ë°˜ì˜ì–´ 10)
            // (ë°ì´í„° ë¶€ì¡± ì‹œ ë°˜ë³µí•´ì„œ ì±„ì›€)
            
            // 1. ì˜ë¯¸
            for(let i=0; i<20; i++) {
                const w = currentWords[i % currentWords.length];
                quizQueue.push({ word: w, type: 'meaning' });
            }
            // 2. ì˜ˆë¬¸
            const exWords = currentWords.filter(w => w.example);
            if(exWords.length > 0) {
                for(let i=0; i<20; i++) quizQueue.push({ word: exWords[i % exWords.length], type: 'example' });
            } else {
                for(let i=0; i<20; i++) quizQueue.push({ word: currentWords[i % currentWords.length], type: 'meaning' });
            }
            // 3. ìœ ì˜ì–´/ë°˜ì˜ì–´
            const synAntWords = currentWords.filter(w => w.synonyms || w.antonyms);
            if(synAntWords.length > 0) {
                for(let i=0; i<10; i++) {
                    const w = synAntWords[i % synAntWords.length];
                    const qType = (w.synonyms && w.antonyms) ? (Math.random()>0.5?'synonym':'antonym') : (w.synonyms?'synonym':'antonym');
                    quizQueue.push({ word: w, type: qType });
                }
            } else {
                for(let i=0; i<10; i++) quizQueue.push({ word: currentWords[i % currentWords.length], type: 'meaning' });
            }

            quizQueue.sort(() => Math.random() - 0.5); // ì„ê¸°
            currentIndex = 0;
            loadQuizQuestion();
        }

        function loadQuizQuestion() {
            const q = quizQueue[currentIndex];
            const w = q.word;
            const qBox = document.getElementById('quiz-question');
            const badge = document.getElementById('quiz-type-badge');
            
            if(q.type === 'example') {
                qBox.innerText = w.example.replace(new RegExp(w.english, 'gi'), '_______');
                badge.innerText = "ë¹ˆì¹¸ì— ë“¤ì–´ê°ˆ ë‹¨ì–´ëŠ”? (Example)";
            } else if(q.type === 'synonym') {
                qBox.innerText = w.synonyms;
                badge.innerText = "ë¹„ìŠ·í•œ ëœ»ì„ ê°€ì§„ ë‹¨ì–´ëŠ”? (Synonym)";
            } else if(q.type === 'antonym') {
                qBox.innerText = w.antonyms;
                badge.innerText = "ë°˜ëŒ€ ëœ»ì„ ê°€ì§„ ë‹¨ì–´ëŠ”? (Antonym)";
            } else {
                qBox.innerText = w.meaning;
                badge.innerText = "ì´ ëœ»ì„ ê°€ì§„ ì˜ì–´ ë‹¨ì–´ëŠ”? (Meaning)";
            }

            const options = [w];
            while(options.length < 4) {
                const rand = currentWords[Math.floor(Math.random() * currentWords.length)];
                if(!options.some(o => o.id === rand.id)) options.push(rand);
            }
            options.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('quiz-options');
            grid.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt.english;
                btn.onclick = () => {
                    if(opt.id === w.id) {
                        btn.classList.add('correct');
                        setTimeout(() => {
                            if(currentIndex < quizQueue.length-1) {
                                currentIndex++;
                                loadQuizQuestion();
                            } else {
                                alert("í›ˆë ¨ ì™„ë£Œ! ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.");
                                backToDashboard();
                            }
                        }, 800);
                    } else {
                        btn.classList.add('wrong');
                    }
                };
                grid.appendChild(btn);
            });
            document.getElementById('quiz-progress').innerText = `${currentIndex+1} / ${quizQueue.length}`;
        }

        function startTest() { alert("ì‹œí—˜ ëª¨ë“œëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!"); }

        // --- 4. ì„ ìƒë‹˜ ëª¨ë“œ ---
        function initTeacherView() { loadBooks(); }
        function renderTeacherTable() {
            const tbody = document.getElementById('teacher-tbody');
            tbody.innerHTML = '<tr><td colspan="5">ì•„ì§ í•™ìƒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        function printTestPaper(type) {
            if (currentWords.length === 0) return alert("ë¨¼ì € í•™ìƒ ëª¨ë“œì—ì„œ ìœ ë‹›ì„ ì„ íƒí•´ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.");
            
            const printArea = document.getElementById('print-tbody');
            const title = document.getElementById('print-title');
            printArea.innerHTML = '';
            
            const words = currentWords; 
            if(type === 'test') {
                title.innerText = "Vocabulary Final Test";
                words.forEach((w, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="print-col-left">${i+1}. ${w.meaning}</td><td class="print-col-right">____________________</td>`;
                    printArea.appendChild(tr);
                });
            } else {
                title.innerText = "Vocabulary Workbook";
                words.forEach((w, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="print-col-left">${i+1}. ${w.english}</td><td class="print-col-right" style="color:#ccc;">ëœ»: ______________<br>Ex: ${w.example ? w.example.replace(w.english, '______') : ''}</td>`;
                    printArea.appendChild(tr);
                });
            }
            window.print();
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function showSection(id) {
            const sections = ['login-section', 'selection-section', 'dashboard-section', 'flashcard-section', 'spelling-section', 'spelling-result-section', 'quiz-section', 'teacher-section'];
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function backToDashboard() { showSection('dashboard-section'); }
        function goBackToSelection() { showSection('selection-section'); }

        document.addEventListener('keydown', function(event) {
            const flashSection = document.getElementById('flashcard-section');
            if (!flashSection.classList.contains('hidden')) {
                if (event.code === 'Space') { event.preventDefault(); flipCard(); }
                if (event.code === 'Enter') { event.preventDefault(); nextCard(); }
                if (event.code === 'ArrowLeft') prevCard();
                if (event.code === 'ArrowRight') nextCard();
            }
        });

        // ì—”í„°í‚¤ ì´ë²¤íŠ¸ ì—°ê²°
        function addEnterListener(id, action) {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') action();
                });
            }
        }
        addEnterListener('spell-input', checkSpelling);
        addEnterListener('password', login);
        addEnterListener('username', login);

    </script>
</body>
</html>